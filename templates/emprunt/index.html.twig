{% extends 'base.html.twig' %}

{% block title %}Emprunts{% endblock %}

{% block body %}
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">üîÑ Emprunts</h1>
                <div class="small muted">Liste des emprunts enregistr√©s</div>
            </div>
            <div>
                {% if is_granted('ROLE_USER') %}
                    <a href="{{ path('app_emprunt_new') }}" class="btn btn-primary">Cr√©er un emprunt</a>
                {% endif %}
                <a href="{{ path('library_home') }}" class="btn btn-ghost">Retour</a>
            </div>
        </div>

        <div class="card" style="margin-bottom:1rem">
            <div class="flex" style="gap:1rem;align-items:center">
                <div style="flex:1">
                    <input id="search" type="search" placeholder="Rechercher par utilisateur ou livre..." class="" style="width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:10px">
                </div>
                <div>
                    <button id="exportCsv" class="btn btn-secondary">Exporter CSV</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="table-wrapper">
                <table id="empruntTable">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Utilisateur</th>
                            <th>Livre</th>
                            <th>Date Emprunt</th>
                            <th>Retour pr√©vu</th>
                            <th>Retour r√©el</th>
                            <th>P√©nalit√©s</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emprunt in emprunts %}
                            {# On s√©curise l'email pour le JS #}
                            {% set userEmail = emprunt.utilisateur ? emprunt.utilisateur.email : 'Inconnu' %}
                            <tr data-utilisateur="{{ userEmail|e }}" data-livre="{{ emprunt.livre|e }}">
                                <td>{{ emprunt.id }}</td>
                                
                                {# Correction : on utilise .utilisateur au lieu de .user #}
                                <td>
                                    <strong>{{ userEmail }}</strong>
                                </td>
                                
                                <td>{{ emprunt.livre }}</td>
                                
                                {# Correction : on utilise les noms exacts de vos propri√©t√©s (Empruntdate) #}
                                <td>{{ emprunt.Empruntdate ? emprunt.Empruntdate|date('d/m/Y') : '-' }}</td>
                                <td>{{ emprunt.dateretour ? emprunt.dateretour|date('d/m/Y') : '-' }}</td>
                                <td>{{ emprunt.dateRetourReelle ? emprunt.dateRetourReelle|date('d/m/Y') : '<span class="badge bg-warning text-dark">En cours</span>'|raw }}</td>
                                
                                <td>{{ emprunt.penalites is not null ? emprunt.penalites ~ ' ‚Ç¨' : '-' }}</td>
                                
                                <td>
                                    <div class="flex" style="gap:0.5rem">
                                        <a class="btn btn-ghost btn-sm" href="{{ path('app_emprunt_show', {'id': emprunt.id}) }}">Voir</a>
                                        
                                        {% if is_granted('ROLE_ADMIN') %}
                                            <a class="btn btn-primary btn-sm" href="{{ path('app_emprunt_edit', {'id': emprunt.id}) }}">Modifier</a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="8" class="center muted">Aucun emprunt trouv√©</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    {% block javascripts %}
        <script>
            (function(){
                const $search = document.getElementById('search');
                const $table = document.getElementById('empruntTable');
                const $rows = Array.from($table.querySelectorAll('tbody tr:not(.muted)'));

                function filter(q){
                    const s = q.trim().toLowerCase();
                    $rows.forEach(r => {
                        const user = (r.dataset.utilisateur || '').toLowerCase();
                        const livre = (r.dataset.livre || '').toLowerCase();
                        const match = !s || user.includes(s) || livre.includes(s);
                        r.style.display = match ? '' : 'none';
                    });
                }

                if($search) {
                    $search.addEventListener('input', e => filter(e.target.value));
                }

                // CSV export
                document.getElementById('exportCsv').addEventListener('click', () => {
                    const visibleRows = $rows.filter(r => r.style.display !== 'none');
                    const lines = [['Id','Utilisateur','Livre','Emprunt','Retour pr√©vu','Retour r√©el','P√©nalit√©s']];
                    visibleRows.forEach(r => {
                        const cells = Array.from(r.querySelectorAll('td')).slice(0,7).map(td => td.textContent.trim());
                        lines.push(cells);
                    });
                    const csv = lines.map(l => l.map(v => '"'+v.replace(/"/g,'""')+'"').join(',')).join('\n');
                    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'emprunts.csv';
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    URL.revokeObjectURL(url);
                });
            })();
        </script>
    {% endblock %}
{% endblock %}