{% extends 'base.html.twig' %}

{% block title %}Gestion des Emprunts{% endblock %}

{% block body %}
    <div class="container">
        <div class="page-header">
            <div>
                <h1 class="page-title">üîÑ Emprunts</h1>
                <div class="small muted">Liste des emprunts enregistr√©s (Vue Administrateur)</div>
            </div>
            <div>
                {% if is_granted('ROLE_ADMIN') %}
                    <a href="{{ path('app_emprunt_new') }}" class="btn btn-primary">‚ûï Cr√©er un emprunt</a>
                {% endif %}
                <a href="{{ path('library_home') }}" class="btn btn-ghost">Retour</a>
            </div>
        </div>

        <div class="card" style="margin-bottom:1rem">
            <div class="flex" style="gap:1rem;align-items:center">
                <div style="flex:1">
                    <input id="search" type="search" placeholder="Rechercher un utilisateur ou un livre..." style="width:100%;padding:.6rem .75rem;border:1px solid var(--border);border-radius:10px">
                </div>
                <div>
                    <button id="exportCsv" class="btn btn-secondary">üì• Exporter CSV</button>
                </div>
            </div>
        </div>
      
        <div class="card">
            <div class="table-wrapper">
                <table id="empruntTable" class="table">
                    <thead>
                        <tr>
                            <th>Id</th>
                            <th>Utilisateur</th>
                            <th>Livre</th>
                            <th>Date Emprunt</th>
                            <th>Retour pr√©vu</th>
                            <th>Retour r√©el</th>
                            <th>P√©nalit√©s</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for emprunt in emprunts %}
                            {# --- PROTECTION CONTRE LES ENTIT√âS FANT√îMES (ID 0, 6, etc.) --- #}
                            {% set userEmail = 'Utilisateur inconnu' %}
                            {% set isValid = false %}

                            {# On utilise une v√©rification tr√®s stricte #}
                            {% if emprunt.utilisateur is defined and emprunt.utilisateur is not null %}
                                {# Cette syntaxe tente d'acc√©der √† l'ID sans charger toute l'entit√© #}
                                {% if emprunt.utilisateur.id > 0 %}
    
                                        {% set userEmail = emprunt.utilisateur.email %}
                                        {% set isValid = true %}
                                   
                                {% endif %}
                            {% endif %}

                            <tr data-utilisateur="{{ userEmail|e }}" data-livre="{{ emprunt.livre|e }}">
                                <td>{{ emprunt.id }}</td>
                                <td>
                                    {% if isValid %}
                                        <strong>{{ userEmail }}</strong>
                                    {% else %}
                                        <span class="badge" style="background-color: #dc3545; color: white; padding: 2px 8px; border-radius: 4px;">
                                            ‚ö†Ô∏è {{ userEmail }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ emprunt.livre }}</td>
                                <td>{{ emprunt.Empruntdate ? emprunt.Empruntdate|date('d/m/Y') : '-' }}</td>
                                <td>{{ emprunt.dateretour ? emprunt.dateretour|date('d/m/Y') : '-' }}</td>
                                <td>
                                    {% if emprunt.dateRetourReelle %}
                                        {{ emprunt.dateRetourReelle|date('d/m/Y') }}
                                    {% else %}
                                        <span class="badge bg-warning text-dark" style="background-color: #ffc107; padding: 2px 8px; border-radius: 4px;">En cours</span>
                                    {% endif %}
                                </td>
                                <td>{{ emprunt.penalites is not null ? emprunt.penalites ~ ' ‚Ç¨' : '0 ‚Ç¨' }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{{ path('app_emprunt_show', {'id': emprunt.id}) }}" class="btn btn-sm btn-info text-white">Voir</a>
                                        {% if is_granted('ROLE_ADMIN') %}
                                            <a href="{{ path('app_emprunt_edit', {'id': emprunt.id}) }}" class="btn btn-sm btn-warning">Modifier</a>
                                            <form method="post" action="{{ path('app_emprunt_delete', {'id': emprunt.id}) }}" style="display:inline-block" onsubmit="return confirm('‚ö†Ô∏è Supprimer cet emprunt ?');">
                                                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ emprunt.id) }}">
                                                <button class="btn btn-sm btn-danger">Supprimer</button>
                                            </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="8" class="text-center muted py-4">Aucun emprunt trouv√©.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascripts %}
    <script>
        // Votre script JS reste identique, il est d√©j√† tr√®s bien.
        (function(){
            const $search = document.getElementById('search');
            const $table = document.getElementById('empruntTable');
            const $rows = Array.from($table.querySelectorAll('tbody tr:not(.muted)'));

            function filter(q){
                const s = q.trim().toLowerCase();
                $rows.forEach(r => {
                    const user = (r.dataset.utilisateur || '').toLowerCase();
                    const livre = (r.dataset.livre || '').toLowerCase();
                    const match = !s || user.includes(s) || livre.includes(s);
                    r.style.display = match ? '' : 'none';
                });
            }

            if($search) {
                $search.addEventListener('input', e => filter(e.target.value));
            }

            document.getElementById('exportCsv').addEventListener('click', () => {
                const visibleRows = $rows.filter(r => r.style.display !== 'none');
                const lines = [['Id','Utilisateur','Livre','Date Emprunt','Retour Prevu','Retour Reel','Penalites']];
                visibleRows.forEach(r => {
                    const cells = Array.from(r.querySelectorAll('td')).slice(0,7).map(td => td.textContent.trim());
                    lines.push(cells);
                });
                const csv = lines.map(l => l.map(v => '"'+v.replace(/"/g,'""')+'"').join(',')).join('\n');
                const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'export_emprunts.csv';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            });
        })();
    </script>
{% endblock %}